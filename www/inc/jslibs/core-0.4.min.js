/**
 * EZCrypt core code
 * 
 * @version: 0.4
 * @author: NovaKing (novaking@eztv.se)
 * 
 * General functions that get used within the website
 * 
 **/
var editor;var ez;var _encrypting=null;$LAB.setGlobalDefaults({UseLocalXHR:true,AlwaysPreserveOrder:false,AllowDuplicates:true});$(function(){if(document.getElementById('content')){editor=CodeMirror.fromTextArea(document.getElementById('content'),{lineNumbers:true,matchBrackets:false,lineWrapping:false,readOnly:true});editor.setOption('mode',$('#syntax').val());editor.focus();}$('#key').val(generateKey());$('#text').live('keydown',function(e){if(e.keyCode==13&&e.ctrlKey){$('#en').click();}});$('#usepassword').change(function(){if(this.checked){$('#typepassword').show();}else{$('#typepassword').hide();}});$('#text').bind('textchange',function(){if(_encrypting!=null){clearTimeout(_encrypting);_encrypting=null;}_encrypting=setTimeout('$( \'#result\' ).val( encrypt( $( \'#key\' ).val(), $( \'#text\' ).val() ) ); _encrypting = null',500);});$('#new').bind('click',function(){$('#text').html('');$('#result').val('');$('#newpaste').slideDown();});$('#clone').bind('click',function(){$('#text').html(editor.getValue()).trigger('textchange');$('#newpaste').slideDown();});$('#tool-wrap').bind('click',function(){var checked=$('#tool-wrap').is(':checked');if(checked==1){$('.tool-wrap').addClass('tool-wrap-on');editor.setOption('lineWrapping',true);}else
{$('.tool-wrap').removeClass('tool-wrap-on');editor.setOption('lineWrapping',false);}});$('#tool-numbers').bind('click',function(){var checked=$('#tool-numbers').is(':checked');if(checked==1){$('.tool-numbers').addClass('tool-numbers-on');editor.setOption('lineNumbers',true);}else
{$('.tool-numbers').removeClass('tool-numbers-on');editor.setOption('lineNumbers',false);}});enableHover();});var timeDiff={time:undefined,setStartTime:function(){d=new Date();this.time=d.getTime();},getDiff:function(){d=new Date();return d.getTime()-this.time;}};function stringBreak(str,col){var result='';for(var i=0;i<str.length;i++){result+=str.charAt(i);if(((i+1)%col==0)&&(0<i)){result+="\n";}}return result;}function generateKey(){var index='abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';var key='';for(var i=1;i<25;i++){key+=index[Math.floor(Math.random()*index.length)]};return key;}function enableHover(){$('#en').hover(function(){$('#result').show();$('#result').focus();},function(){$('#result').hide();$('#text').focus();});}function decrypt(cipher,data){$('#decrypting').show();$('#insertkey').hide();timeDiff.setStartTime();var output=ez.aes.decrypt(cipher,data);var diff=timeDiff.getDiff();$('#execute').html('decryption: '+diff+'ms');$('.cm-s-default').parent().show();$('#decrypting').hide();return output;}function encrypt(cipher,data){return stringBreak(ez.aes.encrypt(cipher,data),96);}function requestData(password){var url=window.location.href;var hash=window.location.hash;var index_of_hash=url.indexOf(hash)||url.length;var hashless_url=url.substr(0,index_of_hash);$.ajax({url:hashless_url,type:'POST',dataType:'json',data:'&p='+password,cache:false,success:function(json){$('#data').val(json.data);$('#syntax').val(json.syntax);editor.setOption('mode',$('#syntax').val());if(hash==''){$('#askpassword').hide();$('#insertkey').show();$('#typekey').focus();}else
{$('#askpassword').hide();editor.setValue(decrypt(hash.substring(1),$('#data').val()));}},error:function(){alert('bad password!');}});}function submitData(){if($('#text').val()==''){return false;}else if(_encrypting==null&&$('#result').val()==''&&$('#text').val()!=''){ezcrypt(lib,function(){ez=this;$('#result').val(encrypt($('#key').val(),$('#text').val()));});}else if(_encrypting!=null&&$('#text').val()!=''){setTimeout('submitData()',100);return false;}$('#en').unbind('mouseenter mouseleave');$('#result').show();var data=$('#result').val();data=encodeURIComponent(data);var password='';if($('#usepassword').is(':checked')){ezcrypt(lib,function(){password=this.sha($('#typepassword').val());});}var ttl=$('#ttl option:selected').val();var syntax=$('#syntax option:selected').val();if(typeof(syntax)=='undefined'){syntax=$('#syntax').val();}$.ajax({url:'/',type:'POST',dataType:'json',data:'&data='+data+'&p='+password+'&ttl='+ttl+'&syn='+syntax,cache:false,success:function(json){window.location='/'+json.id+'#'+$('#key').val();},error:function(){enableHover();alert('error submitting form');}});}